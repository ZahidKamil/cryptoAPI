#include<stdio.h>
#include "opt32/crypto_aead.h"
#include <string.h>
#include <stdlib.h>
#include <stdint.h>
// gcc test_copy.c opt32/aead.c -o test_copy

#define MAX_CT_LEN 40

void generateRandomKey(uint8_t* key, size_t size) {
    for (size_t i = 0; i < size; i++) {
        key[i] = rand() & 0xFF;
    }
}

void vli_print(uint8_t *vli, unsigned int size) {
    for(unsigned i=0; i<size; ++i) {
        printf("%02X ", (unsigned)vli[i]);
    }
    }
int main() {

    // uint8_t key[128];

    // Generate a random 1024-bit key
    // generateRandomKey(key, 128);
    // uint8_t key[] = {
    //     0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    //     0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
    // };

    uint8_t key[] = {
        0x18, 0x6A, 0x2B, 0x9C, 0x6A, 0xD1, 0xC0, 0x88,
        0xF0, 0xA1, 0x9E, 0x96, 0xBA, 0x56, 0x2D, 0x15,
        0x1E, 0x92, 0xB8, 0x1A, 0xBA, 0x88, 0x0D, 0xB6,
        0x62, 0x8D, 0xFA, 0x2F, 0x74, 0xD0, 0x3C, 0x3C,
        0x8C, 0x65, 0x04, 0xE9, 0xF7, 0x30, 0x19, 0xEC,
        0x12, 0x3D, 0x75, 0x25, 0xF2, 0xC4, 0x19, 0x23,
        0xF5, 0xC2, 0xA2, 0xC4, 0xD5, 0xFC, 0x7C, 0xFC,
        0xA9, 0x04, 0xFA, 0x67, 0xCA, 0x10, 0x54, 0x98,
        0x7B, 0xE6, 0x44, 0xCC, 0x7D, 0x90, 0x6C, 0x2D,
        0xD8, 0xFD, 0x01, 0xDB, 0xEE, 0xCB, 0x30, 0x01,
        0x4A, 0x88, 0xE4, 0x96, 0x6C, 0xFE, 0x1A, 0xEA,
        0x80, 0xF6, 0x3E, 0x4F, 0x38, 0xD4, 0x75, 0xD2,
        0x42, 0x31, 0xF5, 0xDA, 0x51, 0xAA, 0x99, 0x19,
        0x27, 0x5A, 0x76, 0xEE, 0xE1, 0x9C, 0xD0, 0xE4,
        0x76, 0x13, 0x6E, 0x56, 0xAC, 0x02, 0x50, 0x41,
        0xAA, 0xF6, 0x8A, 0xDB, 0x18, 0xFA, 0xBC, 0x21
    };

    uint8_t ad[] = {
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
        0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00,
        0x36, 0x44, 0x46, 0x46, 0x42, 0x32, 0x36, 0x34,
        0x42, 0x46, 0x45, 0x41, 0x42, 0x43, 0x45, 0x39,
        0x34, 0x41, 0x44, 0x42, 0x34, 0x39, 0x42, 0x38,
        0x32, 0x44, 0x34, 0x38, 0x32, 0x46, 0x42, 0x32,
        0x41, 0x41, 0x41, 0x34, 0x41, 0x43, 0x37, 0x46,
        0x34, 0x30, 0x38, 0x36, 0x44, 0x37, 0x34, 0x39,
        0x30, 0x34, 0x45, 0x42, 0x32, 0x45, 0x45, 0x43,
        0x35, 0x32, 0x37, 0x35, 0x33, 0x37, 0x43, 0x32,
        0x43, 0x42, 0x41, 0x42, 0x37, 0x33, 0x33, 0x35,
        0x31, 0x45, 0x31, 0x33, 0x30, 0x35, 0x36, 0x30,
        0x41
    };

    // printf("Random 1024-bit Key:\n");
    // for (size_t i = 0; i < 128; i++) {
    //     printf("%02X ", key[i]);
    // }

    uint8_t nonce[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
    };

    unsigned char pt[] = "Hello Bob!"; // Message to be encrypted
    unsigned long long pt_len = strlen((char*)pt); // Length of the plaintext

    // uint8_t ad[] = {0x00};
    unsigned long long ad_len = 130;

    uint8_t ct[MAX_CT_LEN] = {0}; // Output buffer for ciphertext
    unsigned long long ct_len = MAX_CT_LEN; // Length of the ciphertext

    // Call the encryption function
    int ret = crypto_aead_encrypt(
        ct, &ct_len, pt, pt_len, ad, ad_len, NULL, nonce, key
    );

    if (ret == 0) {
        printf("\nCiphertext:\n");
        for (unsigned int i = 0; i < ct_len; ++i) {
            printf("%02X ", ct[i]);
        }
        printf("\n");
    } else {
        printf("\nEncryption failed\n");
        return 1;
    }

    // Decryption
    uint8_t decrypted[MAX_CT_LEN] = {0}; // Output buffer for decrypted message
    unsigned long long decrypted_len = MAX_CT_LEN; // Length of the decrypted message

    // Call the decryption function
    ret = crypto_aead_decrypt(
        decrypted, &decrypted_len, NULL, ct, ct_len, ad, ad_len, nonce, key
    );

    if (ret == 0) {
        printf("Decrypted Message: %.*s\n", (int)decrypted_len, decrypted);
    } else {
        printf("Decryption failed\n");
        return 1;
    }

    // vli_print(key,128);
    // printf("\n\n");
    // vli_print(ad, 130);

    printf("\nDone!\n");
    return 0;
}
